{{ $namespace := .Release.Namespace }}
{{ $productionMode := .Values.production_mode }}
{{ $mysql := .Values.mysql }}

{{- if not (empty .Values.registry.secrets) }}
{{- range $name, $item := .Values.registry.secrets }}
apiVersion: v1
kind: Secret
metadata:
  name: registry-{{ $name }}
  namespace: {{ $namespace }}
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: {{ dict "auths" (dict $item.server (dict "username" $item.username "password" $item.password "email" $item.email "auth" (nospace (cat $item.username ":" $item.password) | b64enc))) | toJson | b64enc }}
---
{{ end -}}
{{- end }}
{{- range $appName, $appConfig := .Values.app.php }}
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    com.yesglasses.deployment: {{ $appName }}
  name: {{ $appName }}
  namespace: {{ $namespace }}
spec:
  replicas: {{ default 1 $appConfig.replicas }}
  selector:
    matchLabels:
      com.yesglasses.pod: {{ $appName }}
  strategy:
    type: {{ default "RollingUpdate" $appConfig.strategy.type }}
    rollingUpdate:
      maxUnavailable: {{ default "25%" $appConfig.strategy.maxUnavailable }}
      maxSurge: {{ default "25%" $appConfig.strategy.maxSurge }}
  template:
    metadata:
      labels:
        com.yesglasses.pod: {{ $appName }}
    spec:
      {{- if not (empty $appConfig.imagePullSecrets) }}
      imagePullSecrets:
        {{- range $index, $item := $appConfig.imagePullSecrets }}
        - name: registry-{{ $item.name }}
        {{- end }}
      {{- end }}
      containers:
        - image: {{ $appConfig.image }}
          imagePullPolicy: {{ default "IfNotPresent" $appConfig.imagePullPolicy }}
          name: php
          resources:
            requests:
              cpu: {{ default "100m" $appConfig.resources.requests.cpu }}
              memory: {{ default "128Mi" $appConfig.resources.requests.memory }}
            limits:
              cpu: {{ default "200m" $appConfig.resources.limits.cpu }}
              memory: {{ default "256Mi" $appConfig.resources.limits.memory }}
          env:
            - name: ENV_PRODUCTION
              value: {{ default "local" $productionMode }}
            {{- if and (not (empty $mysql)) $mysql.enabled }}
            - name: MYSQL_HOST
              value: {{ $mysql.name }}
            - name: MYSQL_RW_PORT
              value: "6446"
            - name: MYSQL_RO_PORT
              value: "6447"
            {{- end }}
          {{- if not (empty $appConfig.health) }}
          readinessProbe:
            httpGet:
              path: {{ $appConfig.health }}
              port: {{ $appConfig.listen }}
              scheme: HTTP
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 2
            successThreshold: 1
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: {{ $appConfig.health }}
              port: {{ $appConfig.listen }}
              scheme: HTTP
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 2
            successThreshold: 1
            failureThreshold: 3
          {{- end }}
          volumeMounts:
            {{- if not (empty $appConfig.mounts) }}
            {{ default "" (toYaml $appConfig.mounts) | nindent 12 }}
            {{- end }}

        {{- if $appConfig.monitor.enabled }}
        - name: php-fpm-exporter
          image: hipages/php-fpm_exporter:2.2
          resources:
            requests:
              cpu: {{ default "10m" $appConfig.monitor.resources.requests.cpu }}
              memory: {{ default "32Mi" $appConfig.monitor.resources.requests.memory }}
            limits:
              cpu: {{ default "20m" $appConfig.monitor.resources.limits.cpu }}
              memory: {{ default "64Mi" $appConfig.monitor.resources.limits.memory }}
          env:
            - name: PHP_FPM_SCRAPE_URI
              value: {{ default "tcp://127.0.0.1:9001/status" $appConfig.monitor.scrapeUri }}
            - name: PHP_FPM_FIX_PROCESS_COUNT
              value: "1"
        {{- end }}

      restartPolicy: {{ $appConfig.restartPolicy }}
      volumes:
        {{- if not (empty $appConfig.volumes) }}
        {{ toYaml $appConfig.volumes | nindent 8 }}
        {{- end }}

---
apiVersion: v1
kind: Service
metadata:
  name: {{ $appName }}
  namespace: {{ $namespace }}
  labels:
    com.yesglasses.service: {{ $appName }}
spec:
  ports:
    - name: tcp-php
      port: {{ $appConfig.listen }}
      targetPort: {{ $appConfig.listen }}
    {{- if $appConfig.monitor.enabled }}
    - name: http-exporter
      port: 9253
      targetPort: 9253
    {{- end }}
  selector:
    com.yesglasses.pod: {{ $appName }}
  type: ClusterIP

---
{{- if $appConfig.monitor.enabled }}
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: {{ $appName }}
  namespace: {{ $namespace }}
  labels:
    com.yesglasses.monitor: {{ $appName }}
spec:
  jobLabel: {{ $appName }}
  namespaceSelector:
    matchNames:
      - {{ $namespace }}
  selector:
    matchLabels:
      com.yesglasses.service: {{ $appName }}
  endpoints:
    - port: http-exporter
{{- end }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $appName }}-nginx-params
  namespace: {{ $namespace }}
  labels:
    com.yesglasses.configmap: {{ $appName }}
data:
  SCRIPT_FILENAME: {{ $appConfig.scriptFile | quote }}

---
{{- if $appConfig.basicAuth.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $appName }}-nginx-auth
  namespace: {{ $namespace }}
  labels:
    com.yesglasses.secret: {{ $appName }}
type: Opaque
data:
  auth: {{ htpasswd $appConfig.basicAuth.username $appConfig.basicAuth.password | b64enc }}
{{- end }}

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ $appName }}
  namespace: {{ $namespace }}
  labels:
    com.yesglasses.ingress: {{ $appName }}
  annotations:
    nginx.ingress.kubernetes.io/service-upstream: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "FCGI"
    nginx.ingress.kubernetes.io/fastcgi-index: "index.php"
    nginx.ingress.kubernetes.io/proxy-body-size: 32M
    nginx.ingress.kubernetes.io/fastcgi-params-configmap: "{{ $appName }}-nginx-params"
    {{- if $appConfig.basicAuth.enabled }}
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: {{ $appName }}-nginx-auth
    nginx.ingress.kubernetes.io/auth-realm: "Authentication Required"
    {{- end }}
spec:
  rules:
    - host: {{ $appConfig.hostname }}
      http:
        paths:
          - path: /
            pathType: ImplementationSpecific
            backend:
              service:
                name: {{ $appName }}
                port:
                  number: {{ $appConfig.listen }}
---
{{- end }}

apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: {{ $namespace }}
  name: jenkins-update-role
rules:
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["update"]

---
apiVersion: v1
kind: ServiceAccount
metadata:
  namespace: {{ $namespace }}
  name: jenkins-update-roler

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  namespace: {{ $namespace }}
  name: jenkins-update-role-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: jenkins-update-role
subjects:
- kind: ServiceAccount
  name: jenkins-update-roler
  namespace: {{ $namespace }}
